#!/bin/bash

# Script to build initrd from a folder.
# The script mloop can unpack an initrd.xz in Porteus v3.0+
# Author: Brokenman

# Color definitions
txtund=$(tput sgr 0 1)          # Underline
txtbld=$(tput bold)             # Bold
txtgreen=${txtbld}$(tput setaf 2) #  green
txtcyan=${txtbld}$(tput setaf 6) #  cyan
txtred=${txtbld}$(tput setaf 1) #  red
rst=$(tput sgr0)             # Reset
function green() {
echo -e $txtgreen "$1" $rst
}

function cyan() {
echo -e $txtcyan "$1" $rst
}

function red() {
echo -e $txtred "$1" $rst
}

# Check that the target folder is valid
[ ! -L init ] || [ ! -e linuxrc ] && { echo -e $txtcyan "This is not a valid initrd folder!" $rst \
	; echo " You must change into the unpacked initrd folder."; exit; }
	
# Check for initrd.txt file containing path to unpacked initrd.xz
# initrd.txt is generated by mloop

[ -e initrd.txt ] && target=`<initrd.txt` || target=/tmp/initrd.xz

# Check that the target directory doesn't have an initrd.xz already
if [ -e $target ]; then
    echo -e $txtcyan "There is already an initrd.xz at $target" $rst
    echo " This file will be over wriiten!"
    echo
    read -p " Would you like to continue? [y/n]" -n 1 -r -s && echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then exit; fi
fi
find | cpio -H newc -o | xz --check=crc32 --x86 --lzma2 > $target
echo " Your initrd.xz has been written to: "
echo -e $txtcyan "$target" $rst

exit 0
